!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("react"),require("react-dropzone"),require("antd"),require("react-overlay-loading/lib/OverlayLoader"),require("deni-react-treeview"),require("superagent"),require("react-icons/lib/fa/trash-o"),require("antd/dist/antd.css")):"function"==typeof define&&define.amd?define(["react","react-dropzone","antd","react-overlay-loading/lib/OverlayLoader","deni-react-treeview","superagent","react-icons/lib/fa/trash-o","antd/dist/antd.css"],t):(e=e||self)["zipping-uploader"]=t(e.React,e.Dropzone,e.antd,e.OverlayLoader,e.TreeView,e.request,e.FaTrashO)}(this,function(i,r,o,a,s,l,u){"use strict";var c="default"in i?i.default:i;function d(e,t,n,i,r,o,a){try{var l=e[o](a),s=l.value}catch(e){return void n(e)}l.done?t(s):Promise.resolve(s).then(i,r)}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t,n){return t&&p(e.prototype,t),n&&p(e,n),e}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?g(e):t}r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a,s=s&&s.hasOwnProperty("default")?s.default:s,l=l&&l.hasOwnProperty("default")?l.default:l,u=u&&u.hasOwnProperty("default")?u.default:u;var w="done",F="removed",x="uploading",k="root",C=function(){function e(){f(this,e)}return h(e,null,[{key:"getFolderPath",value:function(e){var t=e.name;return e.path.replace(t,"")}},{key:"getListFolders",value:function(e){var t=e.split("/").filter(function(e){return 0<e.length});return t.unshift(k),t}},{key:"getFoldersArray",value:function(e){return this.getListFolders(this.getFolderPath(e))}},{key:"uploadFile",value:function(e,t,n,i,r,o){l.post(e).set(t).attach("files",n.content,n.name).on("progress",function(e){o.setState({loadingText:"Uploading file ... "+e.percent.toFixed(2)+" %"}),n.status=x,i(n,null)}).then(function(e){r(n,e)}).end()}}]),e}();function e(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css","top"===n&&i.firstChild?i.insertBefore(r,i.firstChild):i.appendChild(r),r.styleSheet?r.styleSheet.cssText=e:r.appendChild(document.createTextNode(e))}}e(".button-done {\n  width: 400px;\n  margin-top: 20px;\n}\n\n.loading {\n  width: 100%;\n  height: 100%;\n  background: rgba(0,0,0,0.7);\n  position: fixed;\n  top: 0;\n  left: 0;\n  z-index: 100;\n}");var E=function(e){function t(){var r;return f(this,t),v(g(g(r=b(this,y(t).call(this)))),"onActionButtonClick",function(e,t){var n=t.type.name,i=r.refs.treeview.api;switch(n){case"FaTrashO":e&&i.removeItem(e.id)}}),v(g(g(r)),"submitFiles",function(){r.props.onSubmit(r.state.data)}),r.state={data:[]},r}var l,n;return m(t,i.Component),h(t,[{key:"componentDidMount",value:function(){this.parseTreeView(this.props.files)}},{key:"componentWillReceiveProps",value:function(e){var t=this.props.files;this.setState({data:[]}),e.files!==t&&this.parseTreeView(e.files)}},{key:"parseTreeView",value:(l=regeneratorRuntime.mark(function e(t){var n,i,r,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=[],i=0;i<t.length;i++)r=t[i],o=C.getFoldersArray(r),a={id:r.preview,text:r.name,isLeaf:!0,data:r},this.build(n,o,a);return 1===n[0].children.length&&(n=n[0].children),e.next=5,this.setState({data:n});case 5:case"end":return e.stop()}},e,this)}),n=function(){var e=this,a=arguments;return new Promise(function(t,n){var i=l.apply(e,a);function r(e){d(i,t,n,r,o,"next",e)}function o(e){d(i,t,n,r,o,"throw",e)}r(void 0)})},function(e){return n.apply(this,arguments)})},{key:"build",value:function(e,t,n){if(Array.isArray(t)&&1===t.length){var i=this.getDirectoryObj(e,t[0]);null===i?e.push({id:t[0],text:t[0],children:[n]}):"children"in i?i.children.push(n):i.children=[n]}else{var r=t.shift(),o=this.getDirectoryObj(e,r);null===o&&(o={id:t.join()+","+r,text:r,children:[]},e.push(o)),this.build(o.children,t,n)}}},{key:"getDirectoryObj",value:function(e,t){var n=e.filter(function(e){return e.text===t});return 0<n.length?n[0]:null}},{key:"render",value:function(){var e=[c.createElement(u,{size:"15",color:"#ff704d"})];return c.createElement("div",null,c.createElement(s,{items:this.state.data,ref:"treeview",selectRow:!0,actionButtons:e,onActionButtonClick:this.onActionButtonClick}),c.createElement(o.Button,{type:"primary",className:"button-done",onClick:this.submitFiles},"Submit"))}}]),t}();e(".dropzone {\n  width: 100%;\n  height: 100%;\n}\n\n.dropzone div {\n  width: 100% !important;\n  height: 100% !important;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n}");var O=require("jszip"),S=require("file-selector").fromEvent,T=require("react-fontawesome"),z=o.Modal.confirm;return function(e){function t(e){var i;return f(this,t),v(g(g(i=b(this,y(t).call(this,e)))),"onDrop",function(e){i.setState({files:e,isVisibleFileSelection:!0})}),v(g(g(i)),"submitFiles",function(e){var t=[];i.zip=new O,i.setState({isVisibleLoading:!0,loadingText:"Reading folder ..."}),i.getLeaves(t,e);var n=e[0].text===k?(new Date).getTime()+".zip":e[0].text+".zip";i.zipThenUploadFile(t,n),i.setState({isVisibleFileSelection:!1})}),v(g(g(i)),"onUploadDone",function(e,t){void 0!==t&&void 0!==t.body||o.message.error("Uploaded error.");var n=i.state.uploaded;e.response=t.body,e.status=w,n.push(e),i.setState({isVisibleLoading:!1}),i.onChanged(e,n)}),v(g(g(i)),"onChanged",function(e,t){if(void 0!==i.props.onChanged){var n={file:e,fileList:t};i.props.onChanged(n)}}),v(g(g(i)),"onCancel",function(){i.setState({isVisibleFileSelection:!1})}),v(g(g(i)),"onRemoveUploadedFile",function(e,n){e.preventDefault(),void 0!==n&&void 0!==n.name&&z({title:"Are you sure to remove this uploaded file?",content:"",onOk:function(){var e=i.state.uploaded.filter(function(e){return e.uid!==n.uid});if(i.setState({uploaded:e}),void 0!==i.props.onChanged){n.status=F;var t={file:n,fileList:e};i.props.onChanged(t)}},onCancel:function(){}})}),i.state={url:"",headers:{"Content-Type":"application/zip"},files:[],uploaded:[],isVisibleFileSelection:!1,loadingText:"",isVisibleLoading:!1},i}return m(t,i.Component),h(t,[{key:"componentDidMount",value:function(){void 0!==this.props.url&&this.setState({url:this.props.url}),void 0!==this.props.headers&&this.setState({headers:this.props.headers})}},{key:"componentWillReceiveProps",value:function(e){this.props.fileList!==e.fileList&&this.setState({uploaded:e.fileList})}},{key:"zipThenUploadFile",value:function(e,n){for(var i=this,r=this.state.url,o=this.state.headers,t=0;t<e.length;t++){for(var a=e[t],l=C.getFoldersArray(a),s=this.zip,u=0;u<l.length;u++){var c=l[u];c!==k&&(s=s.folder(c))}s.file(a.name,a)}var d=this.onUploadDone;this.zip.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:1},streamFiles:!0},function(e){if(i.setState({loadingText:"Zipping file ... "+e.percent.toFixed(2)+" %"}),null!==e.currentFile){var t={name:e.currentFile,status:x};i.onChanged(t,null)}}).then(function(e){var t={name:n,content:e};i.setState({loadingText:"Uploading file ... 0 %"}),C.uploadFile(r,o,t,i.onChanged,d,i)})}},{key:"getLeaves",value:function(t,e){var n=this;e.forEach(function(e){e.isLeaf?t.push(e.data):n.getLeaves(t,e.children)})}},{key:"render",value:function(){var n=this;return c.createElement("section",{className:"dropzone"},c.createElement(a,{color:"#23AE84",loader:"BeatLoader",text:this.state.loadingText,active:this.state.isVisibleLoading,backgroundColor:"black",opacity:".6"},c.createElement("div",{className:"dropzone-box"},c.createElement(r,{getDataTransferItems:function(e){return S(e)},onDrop:this.onDrop},c.createElement("p",null,"Drop a folder with files here.")),c.createElement(o.Modal,{visible:this.state.isVisibleFileSelection,ref:"modal",title:"File directory",footer:null,width:450,onCancel:this.onCancel},c.createElement(E,{files:this.state.files,onSubmit:this.submitFiles}))),c.createElement("div",{className:"dropzone-files"},0<this.state.uploaded.length&&this.state.uploaded.map(function(t,e){return c.createElement("div",{key:e,className:"uploaded-file"},c.createElement("a",{key:"del_"+e,className:"file-remove",onClick:function(e){return n.onRemoveUploadedFile(e,t)}},c.createElement(T,{className:"super-crazy-colors",name:"remove"})),c.createElement("a",{key:e,href:t.url},t.name))}))))}}]),t}()});
